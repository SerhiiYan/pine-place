---
import { Icon } from 'astro-icon/components';

// Компонент получает и listing, и host
const { listing, host } = Astro.props;

// --- ЛОГИКА ДАННЫХ ---
const getBasePrice = (l) => {
  try {
    const priceItem = l?.conditions?.sections?.find(s => s.title === "Основные цены")?.items?.[0]?.value;
    return priceItem ? priceItem.match(/\d+/)[0] : null;
  } catch (e) { return null; }
};

const basePrice = getBasePrice(listing);

const contactIcons = {
  phone: 'mdi:phone',
  instagram: 'mdi:instagram',
  telegram: 'mdi:telegram',
  website: 'mdi:web',
  default: 'mdi:email-outline'
};

// Логика теперь правильно работает с `host.contacts`
const phoneContact = host?.contacts?.find(c => c.type === 'phone');
const otherContacts = host?.contacts?.filter(c => c.type !== 'phone');
---

{/* --- ВЕРСТКА КОМПОНЕНТА --- */}
<div class="widget-box">
  <div class="price-line">
    {basePrice ? (
      <>
        <span class="price-prefix">от</span>
        <span class="price-amount">{basePrice} BYN</span>
        <span class="per-night">/ ночь</span>
      </>
    ) : (
      <span class="price-amount">Цена по запросу</span>
    )}
  </div>

  <div class="cta-buttons">
    {/* Сначала рендерим все контакты, КРОМЕ телефона */}
    {otherContacts?.map((contact, index) => {
      const iconName = contactIcons[contact.type] || contactIcons.default;
      // Первая кнопка в списке будет основной, остальные - второстепенными
      const buttonClass = index === 0 ? 'btn btn-primary' : 'btn btn-secondary';
      return (
        <a href={contact.value} class={buttonClass} target="_blank" rel="noopener noreferrer">
          <Icon name={iconName} />
          <span>{contact.label}</span>
        </a>
      )
    })}
    
    {/* Потом отдельно рендерим нашу "умную" ссылку на телефон */}
    {phoneContact && (
      <a href={`tel:${phoneContact.value}`} class="phone-link">
        <Icon name={contactIcons.phone} />
        <span>{phoneContact.value}</span>
      </a>
    )}
  </div>

  <p class="disclaimer">Нажимая кнопку, Вы связываетесь напрямую с владельцем.</p>
</div>


{/* --- СТИЛИ КОМПОНЕНТА --- */}
<style>
  .widget-box {
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .price-line {
    margin-bottom: 1.5rem;
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }
  .price-prefix {
    font-size: 1.2rem;
    font-weight: 700;
    color: #1a1a1a;
  }
  .price-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a1a1a;
  }
  .per-night {
    font-size: 1rem;
    color: #6c757d;
  }
  
  .cta-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Общий базовый класс для всех кнопок */
  .btn, .phone-link {
    width: 100%;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    box-sizing: border-box;
    transition: background-color 0.2s;
  }
  
  /* Стили для основной кнопки */
  .btn-primary {
    background-color: #2C3E3A;
    color: #fff;
    border: 1px solid transparent;
  }
  .btn-primary:hover {
    background-color: #1f2c29;
  }

  /* Стили для второстепенных кнопок */
  .btn-secondary {
    background-color: #f8f9fa;
    color: #212529;
    border: 1px solid #e9ecef;
  }
  .btn-secondary:hover {
    background-color: #e9ecef;
  }
  
  /* "УМНАЯ" КНОПКА ТЕЛЕФОНА */
  .phone-link {
    background-color: #f8f9fa;
    color: #212529;
    border: 1px solid #e9ecef;
    cursor: default;
    pointer-events: none;
  }

  @media (max-width: 768px) {
    .phone-link {
      cursor: pointer;
      pointer-events: auto;
    }
    .phone-link:hover {
      background-color: #e9ecef;
    }
  }

  .disclaimer {
    font-size: 0.8rem;
    color: #6c757d;
    text-align: center;
    margin: 1.5rem 0 0 0;
  }
</style>